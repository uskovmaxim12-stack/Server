<!DOCTYPE html>
<html>
<head>
    <title>Клиент для сайта</title>
    <script>
        class SimpleRealtime {
            constructor(serverUrl) {
                this.server = serverUrl || window.location.origin.replace('http', 'ws');
                this.ws = null;
                this.data = {};
                this.callbacks = {};
                this.connect();
            }
            
            connect() {
                this.ws = new WebSocket(this.server + '/ws');
                
                this.ws.onopen = () => {
                    console.log('✅ Подключено к серверу');
                    this.emit('connected');
                };
                
                this.ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        if (msg.type === 'DATA_UPDATED') {
                            this.data[msg.data.key] = msg.data.value;
                            this.emit('update', msg.data);
                        }
                        this.emit(msg.type, msg.data);
                    } catch (err) {
                        console.error('Ошибка:', err);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('❌ Отключено');
                    setTimeout(() => this.connect(), 3000);
                };
            }
            
            on(event, callback) {
                this.callbacks[event] = this.callbacks[event] || [];
                this.callbacks[event].push(callback);
            }
            
            emit(event, data) {
                (this.callbacks[event] || []).forEach(cb => cb(data));
            }
            
            async get(key) {
                const res = await fetch(this.server.replace('ws', 'http') + `/api/data/${key}`);
                return await res.json();
            }
            
            async set(key, value) {
                const res = await fetch(this.server.replace('ws', 'http') + '/api/data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({key, value})
                });
                return await res.json();
            }
        }
        
        // Автоматическое подключение при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            window.siteData = new SimpleRealtime();
            
            // Пример использования:
            window.siteData.on('connected', () => {
                console.log('Сайт подключен к серверу!');
            });
            
            window.siteData.on('update', (data) => {
                console.log('Данные обновлены:', data);
                // Обновляем интерфейс
                document.dispatchEvent(new CustomEvent('data-updated', {detail: data}));
            });
        });
    </script>
</head>
<body>
    <h1>Ваш сайт подключен к RealTime серверу</h1>
    <div id="realtime-data">Данные будут здесь...</div>
    
    <script>
        // Пример использования на вашем сайте
        document.addEventListener('data-updated', (e) => {
            const data = e.detail;
            document.getElementById('realtime-data').innerHTML = 
                `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        });
        
        // Получить начальные данные
        if (window.siteData) {
            window.siteData.get('content').then(data => {
                console.log('Загружены данные:', data);
            });
        }
    </script>
</body>
</html>
